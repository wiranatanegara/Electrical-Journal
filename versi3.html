<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analisis Data Transaksi ATM (Filter Gagal)</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; }
    .container { max-width:900px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2 { text-align:center; }
    textarea { width:100%; height:160px; padding:10px; font-size:14px; border:1px solid #ccc; border-radius:5px; }
    button { margin-top:10px; width:100%; padding:10px; font-size:16px; background:#dc3545; color:#fff; border:none; border-radius:5px; cursor:pointer; }
    button:hover { background:#c82333; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#343a40; color:#fff; }
    .failed { background:#f8d7da; }
    #detailOutput { margin-top:30px; }
    .segmentDetail { margin-bottom:25px; }
    .segmentDetail pre { background:#fff; padding:10px; border:1px solid #ccc; border-radius:4px; overflow-x:auto; }
    .errorLine { background:yellow; display:block; }
    .legend { margin-top:20px; }
    .legend dt { font-weight:bold; margin-top:10px; }
    .legend dd { margin:0 0 10px 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Analisis Data Transaksi ATM (Hanya GAGAL)</h2>
    <textarea id="inputData" placeholder="Salin-paste log transaksi EJ di sini…"></textarea>
    <button id="btnProcess">Tampilkan Hanya Gagal</button>

    <table id="outputTable">
      <thead>
        <tr>
          <th>No</th>
          <th>Tanggal</th>
          <th>Waktu</th>
          <th>Has Reply</th>
          <th>TSI</th>
          <th>Cash</th>
          <th>Jumlah Error</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="detailOutput"></div>

    <dl class="legend">
      <dt>Keterangan Kolom</dt>
      <dd><strong>No</strong>: Urutan transaksi gagal</dd>
      <dd><strong>Tanggal</strong>: DD/MM/YYYY atau YYYY-MM-DD dari log</dd>
      <dd><strong>Waktu</strong>: jam pertama muncul (hh:mm:ss)</dd>
      <dd><strong>Has Reply</strong>: “Ya” jika ada `TRANSACTION REPLY`</dd>
      <dd><strong>TSI</strong>: kode 4-hex (7000=online, 6000=offline, -=tidak tercatat)</dd>
      <dd><strong>Cash</strong>: “Ya” jika ada `CASH REQUEST` atau `PHYSICAL CASSETTE`</dd>
      <dd><strong>Jumlah Error</strong>: berapa baris `COMMUNICATION ERROR`/`OFFLINE`</dd>
    </dl>
  </div>

    <!-- ... bagian HTML atas tetap sama ... -->

    <script>
        document.getElementById("btnProcess").addEventListener("click", processData);
  
        function processData() {
          const raw = document.getElementById("inputData").value.trim();
          if (!raw) return alert("Masukkan data transaksi terlebih dahulu!");
  
          const lines = raw.split("\n").map(l => l.trim());
          const segments = [];
          let current = null;
  
          // Parse setiap segmen
          lines.forEach(line => {
            if (line.includes("TRANSACTION START")) {
              current = {
                lines: [], date:null, reply:false, tsi:null, cash:false,
                errorLines: []
              };
            }
            if (!current) return;
  
            current.lines.push(line);
            // Tanggal
            if (!current.date) {
              const m = line.match(/(\d{2}\/\d{2}\/\d{2,4}|\d{4}-\d{2}-\d{2})/);
              if (m) current.date = m[1];
            }
            // Reply
            if (/^TRANSACTION REPLY/i.test(line)) current.reply = true;
            // TSI
            const mTSI = line.match(/TSI:\s*([0-9A-Fa-f]{4})/);
            if (mTSI) current.tsi = mTSI[1];
            // Cash
            if (/CASH REQUEST|PHYSICAL CASSETTE/i.test(line)) current.cash = true;
            // Error
            if (/COMMUNICATION ERROR|COMMUNICATION OFFLINE|CDM ERROR|FAILED/i.test(line)) {
              current.errorLines.push(line);
            }
            // End segmen
            if (line.includes("TRANSACTION END")) {
              segments.push(current);
              current = null;
            }
          });
  
          // **Filter hanya segmen dengan jumlah error ≥ 2**
          const filtered = segments.filter(s => s.errorLines.length >= 1);
  
          // Render ringkasan tabel
          const tbody = document.querySelector("#outputTable tbody");
          tbody.innerHTML = "";
          filtered.forEach((s, i) => {
            const row = tbody.insertRow();
            row.classList.add("failed");
            const waktu = (s.lines.join(" ").match(/\d{2}:\d{2}:\d{2}/) || ["-"])[0];
            row.insertCell().textContent = i + 1;
            row.insertCell().textContent = s.date || "-";
            row.insertCell().textContent = waktu;
            row.insertCell().textContent = s.reply ? "Ya" : "Tidak";
            row.insertCell().textContent = s.tsi || "-";
            row.insertCell().textContent = s.cash ? "Ya" : "Tidak";
            row.insertCell().textContent = s.errorLines.length;
          });
  
          // Render detail tiap segmen (error disorot kuning)
          const detail = document.getElementById("detailOutput");
          detail.innerHTML = "<h3>Detail Segmen (Error ≥ )</h3>";
          filtered.forEach(s => {
            const div = document.createElement("div");
            div.className = "segmentDetail";
            const pre = document.createElement("pre");
            pre.innerHTML = s.lines.map(line =>
              /COMMUNICATION ERROR|COMMUNICATION OFFLINE|CDM ERROR|FAILED/i.test(line)
                ? `<span class="errorLine">${line}</span>`
                : line
            ).join("\n");

            div.appendChild(pre);
            detail.appendChild(div);
          });
        }
      </script>
  
</body>
</html>
